---
layout: post
title: 굴비와 예제로 공부해 보는 SOCKMAP과 스플라이싱
date: 2025-12-16 16:34:00 +0900
categories: [network]
---

# TCP 스플라이싱: 궁극의 리버스 프록시 뽑기

학부 실습부터 현업까지 흔히 사용을 하는 NGINX, HAProxy와 같은 리버스 프록시들은 태생적으로 L7 프록시이고 커널<->유저랜드 간의 데이터 전달이 잦은 데서부터 일단 성능의 극한으로 뽑아낼 수도 없다.

다르게 말하면, 애초에 커널 영역에서 가능한 많은 것을 처리하면 그만인 것인데, 그런 의미에서 SOCKMAP 인프라스트럭쳐는 클라우드플레어 블로그에서는 성배라고까지 언급이 되는 좋은 방법이 된다.
이 API는 아주 신뢰할 수 있고, 무거운 애플리케이션에 대한 프록시에서 엄청난 성능 변화를(위에서 언급한 블로그에선 지각 변동이라고까지 언급한) 가져올 수 있다.

## L7 프록시보다 나은 점이 뭐지?

여기서 난 좀 맛있는 비유를 들고자 한다.
여러분은 어부이고 필요한 만큼 조기를 옮기고자 한다. 거래처에선 엄청나게 많은 조기를 옮겨 주기를 원한다.

두 가지 방법이 있다고 해 보자:
  1. 조기를 하나하나 바구니에 옮겨 담아서 포장업체에 주고, 업체는 그걸 따로 트럭에 쌓아서 보낸다
  2. 미리 조기끼리 묶어서 굴비로 만들어 놨다가 바로 적당히 남는 크기의 박스에 넣고 우리 수협의 트럭을 쓴다.

조기가 120마리일 때, 1번 경우는 총 120 박스를 하나하나 포장해서 포장업체에 넘기고, 트럭에서 수송하게 된다.
2번 경우는, 조기 6두릅(1두릅=20마리)를 제일 큰 박스에 포장해서 우리 트럭으로 보낸다.

포장업체로의 수하물 이송 시간이 빠지는 걸 제외해도, 굴비 1마리만 들어가는 박스라고 쳐도 1두릅이 1마리처럼 취급되니 20배 빠르다.
만약 물량 발주가 적어서 6두릅이 들어가는 박스를 찾았으면 소요 시간은 1, 즉 1번보다 120배가 빠르다.

확실히 지각 변동이라고 말할 만한 변화이다.
만약 최악(모든 박스가 굴비 1개만함)과 최선(한 박스에 굴비가 다 들어감)의 중간값을 생각을 한다고 해도, 수하물 위탁을 빼도 `(6+1)/2 == 3.5; 120/3.5 == 약 34.28x`로 충분히 위력적인 속도가 나온다.

왜 클라우드플레어 블로그에서 지각 변동이라고 했는지 알 만한 지점이다.

그럼 이제 보통 이럴때 쓰는 함수들끼리 비교해 보자.

## 어떤 함수들이 있는 걸까?

이게 굉장히 재밌는 부분이다. sendfile vs splice vs **vm**splice를 볼 수 있는 대목이다.
sendfile은 디스크파일로부터 소켓으로 읽어오는 형태이고, 제로카피는 아니지만 유저 스페이스 메모리 복사는 피한다.

또 비유하자면, 굴비 냉동창고에서 굴비를 꺼낸 후 박스에 담아 수협 트럭에 싣는 격이다.

splice는 파이프로부터 소켓으로 읽어오고 네트워크 소켓으로의 복사, 그리고 그 역방향도 하는 제로카피인데, 이건 냉동창고에서 굴비를 꺼내 주는 역할을 하는 직원에게서 받아서 수협 **거의 운송속도가 없는 고속 컨베이어벨트로** 트럭에 쑤셔넣고, 돌아오면 거래처에서 온 해산물을 꺼내고 다시 굴비를 싣는 것이다.
왜 리누스가 sendfile을 선호하지 않았는지 알 만하다. (단, `SPLICE_F_MOVE`가 아닐 시 제로 카피가 아닐수도 있음)

vmsplice는 메모리 영역으로부터(특히 가상의 연속된 메모리 공간으로부터) 파이프로 실어 나르는 형태인데, 유저 스페이스 메모리를 피할 수 없지만 제로 카피이다. 이건 위탁 업체의 배송 서비스를 사용하지만, 위탁 업체의 트럭이 바로 옆 회사라 고속 벨트로 꽂아넣는다고 보면 된다.

가상의 연속 메모리 영역을 쓸 일이 있으면 vmsplice, 아니면 splice를 쓰면 될 것 같다.
메모리가 부족한 상황이라면 vmsplice를 활용하는 것도 좋으나 페이지 정렬 이슈 등 성능에서의 희생(trade-off)는 감수를 해야 한다.

## 그럼 NGINX, HAProxy는 뭘 한건데?

NGINX는 한 마디로 말하면 이거다. 어떤 곳이 굴비를 자주 받아가는 경우 뭘 받는지 정보를 기억해 놨다가 바로 영광 x업체 굴비를 주자.
이 방식은 그때그때 정보를 새로 불러올 필요가 없으니 성능은 빠르나, 예기치 못하게 y업체 굴비를 받아야 할 경우에 대응하지 못하고 x업체 굴비를 줄 위험이 있다. 캐싱 문제를 한 번쯤 경험해 봤다면 이것과 유사한 상황임을 체감하기 더 좋을 것이다.

HAProxy는 경로를 다양하게 쓴다고 보면 된다. 대규모 운송을 해야 할때, 영광<->서울로 가는 경로는 다양할 것이다.
좁은 도로를 달려야 하는 경우도 있기 때문에 HAProxy는 다양한 경로로 트럭을 운행해서 도착해야 하는 시간에 늦지 않게 굴비가 배달되는 것을 목표로 한다.

직접 커널 API를 호출하지 않는다는 점에서는 아주 훌륭한 접근이지만, 애초에 중간 경로를 줄여 버리면 운송 속도가 빨라지는 것은 당연한 것이다.

## 파이썬 예제로 보는 Naive와 Splice의 차이

### Naive(Splice 안씀)

```python
while data:
    data = read(sd, 4096)
    writeall(sd, data)
```


### Splice

```python
pipe_rd, pipe_wr = pipe()
fcntl(pipe_rd, F_SET_PIPE_SZ, 4096) #굴비로 비유하면 4096개 굴비가 1묶음이다
while n
    n = splice(sd, pipe_wr, 4096)
    splice(pipe_rd, sd, n)
```

이 경우 만약 몇 묶음을 한 번에 보낼 수 있어지는 상황에선 splice 함수가 묶어서 보내게 된다.
이미 API가 잘 되어 있기 때문에 생각보다 파괴적인 수정 없이도 쉽게 만들 수가 있다.

## SOCKMAP: eBPF를 여기 쓴다고? 무시무시한 성능이다!
이건 정말로 어마어마한 방식이다.
(그럴 일은 없지만) 이건 영광군 모 공장에서 서울 모 거래처 사이를 지나는 고속열차를 만들어서, 트럭이라는 느린 매개체를 거치지 않고 열차에 실어 보내는 방법이라고 생각해도 좋다.

커널에서는 기본 동작이 파이프를 타고 버퍼링되어 나가는 것이기 때문에 속도가 늘어질 수밖에 없는데 이것을 eBPF 프로그램이 우회해서 처리하는 것이다.

```bash
yjlee@yjlee-linuxonmac:~/cloudflare-study/ebpf-sockmap$ sudo ./echo-sockmap 127.0.0.1:8080
[+] Accepting on 127.0.0.1:8080 busy_poll=0
[+] rx=102400001 tx=0
^C
yjlee@yjlee-linuxonmac:~/cloudflare-study/ebpf-sockmap$ sudo ./echo-naive 127.0.0.1:8080
[+] Accepting on 127.0.0.1:8080 busy_poll=0
[-] edge side EOF
[+] Read 97.7MiB in 1075.9ms
^C
yjlee@yjlee-linuxonmac:~/cloudflare-study/ebpf-sockmap$ sudo ./echo-splice 127.0.0.1:8080
[+] Accepting on 127.0.0.1:8080 busy_poll=0
[-] edge side EOF
[+] Read 97.7MiB in 1064.3ms
^C
```

Sockmap은 너무 빨라서 tx/rx로 표기해야 볼 수 있는 경지에 이르렀는데, splice는 잘 쳐줘 봐야 11ms 줄였다.
이건 마치 아무리 뛰어난 트럭 운전사를 고용해도 KTX나 SRT 고속 열차처럼 초속 300km로 운행할 수 없는 것과 마찬가지이다.
이런 압도적인 성능은 고성능 프록시에서 매력적이고, 당연히 ISP 등지에서 눈독들일 수밖에 없는 기술이다.

직접 실행해보려면, ARM64 머신에서도 어셈블리 최적화가 되고, 커널에 부착 시 attach type을 명시하게 개량한 공부용 예제를 사용해 보자.

[벤치마크 소스](https://github.com/gg582/cloudflare-study/tree/main/ebpf-sockmap)


## 마치며
적절하다고 생각한 비유에 생선을 사용해 보니 차이를 이해하기가 쉬웠고, 어떻게 보면 맛있는 공부가 되었다.
네트워크에 대해 잘 모르는 나와 같은 초심자도 이러한 공부를 해보면 재미가 좋으니, 꾸준히 네트워크 게시판에 포스팅하도록 하겠다.
