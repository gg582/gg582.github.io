<!-- Translation Controls -->
<div class="translation-controls" style="margin-bottom: 20px; position: relative; z-index: 100;">
  <div style="position: relative; display: inline-block;">
    <button id="translate-btn" class="btn btn-sm btn-outline-secondary" aria-label="ë²ˆì—­ ì–¸ì–´ ì„ íƒ">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
        <path d="M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z"/>
        <path d="M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066 0 0 1-.415-.492 1.988 1.988 0 0 1-.94.31z"/>
      </svg>
      TRANSLATE
    </button>
    <div id="translate-dropdown" style="display: none; position: absolute; top: 100%; left: 0; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 400px; overflow-y: auto; min-width: 220px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-top: 2px;">
      <div style="padding: 10px; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: 600; font-size: 13px; color: #495057;">
        Select Language
      </div>
      <!-- Options populated by JS -->
    </div>
  </div>
  <button id="translate-reset-btn" class="btn btn-sm btn-outline-danger" style="display: none; margin-left: 8px;" aria-label="ë²ˆì—­ ì´ˆê¸°í™”">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px; vertical-align: text-bottom;">
      <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
      <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
    </svg>
    RESET
  </button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const translateBtn = document.getElementById('translate-btn');
    const resetBtn = document.getElementById('translate-reset-btn');
    const dropdown = document.getElementById('translate-dropdown');
    
    // Configuration constants
    const MAX_TEXT_LENGTH = 500;
    const MAX_ELEMENTS_TO_TRANSLATE = 100;
    const BATCH_SIZE = 10;
    const BATCH_DELAY_MS = 1000;
    
    // Language configuration
    const languages = {
      'en': { name: 'ðŸ‡¬ðŸ‡§ English', code: 'en-GB' },
      'ja': { name: 'ðŸ‡¯ðŸ‡µ æ—¥æœ¬èªž (Japanese)', code: 'ja-JP' },
      'zh-CN': { name: 'ðŸ‡¨ðŸ‡³ ç®€ä½“ä¸­æ–‡ (Simplified Chinese)', code: 'zh-CN' },
      'zh-TW': { name: 'ðŸ‡¹ðŸ‡¼ ç¹é«”ä¸­æ–‡ (Traditional Chinese)', code: 'zh-TW' },
      'es': { name: 'ðŸ‡ªðŸ‡¸ EspaÃ±ol (Spanish)', code: 'es-ES' },
      'fr': { name: 'ðŸ‡«ðŸ‡· FranÃ§ais (French)', code: 'fr-FR' },
      'de': { name: 'ðŸ‡©ðŸ‡ª Deutsch (German)', code: 'de-DE' },
      'ru': { name: 'ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹ (Russian)', code: 'ru-RU' },
      'pt': { name: 'ðŸ‡µðŸ‡¹ PortuguÃªs (Portuguese)', code: 'pt-PT' },
      'it': { name: 'ðŸ‡®ðŸ‡¹ Italiano (Italian)', code: 'it-IT' },
      'ar': { name: 'ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)', code: 'ar-SA' },
      'hi': { name: 'ðŸ‡®ðŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€ (Hindi)', code: 'hi-IN' },
      'th': { name: 'ðŸ‡¹ðŸ‡­ à¹„à¸—à¸¢ (Thai)', code: 'th-TH' },
      'vi': { name: 'ðŸ‡»ðŸ‡³ Tiáº¿ng Viá»‡t (Vietnamese)', code: 'vi-VN' }
    };

    // Populate dropdown immediately
    populateDropdown();
    
    // Check if already translated
    const currentLang = localStorage.getItem('selectedLanguage');
    if (currentLang && currentLang !== 'ko') {
      resetBtn.style.display = 'inline-block';
      updateButtonText(currentLang);
    }

    function populateDropdown() {
      dropdown.innerHTML = '';
      
      // Create header
      const header = document.createElement('div');
      header.style.padding = '10px';
      header.style.borderBottom = '1px solid #eee';
      header.style.background = '#f8f9fa';
      header.style.fontWeight = '600';
      header.style.fontSize = '13px';
      header.style.color = '#495057';
      header.textContent = 'Select Language';
      dropdown.appendChild(header);
      
      // Create language options
      Object.keys(languages).forEach(langCode => {
        const item = document.createElement('div');
        item.textContent = languages[langCode].name;
        item.style.padding = '10px 15px';
        item.style.cursor = 'pointer';
        item.style.fontSize = '14px';
        item.style.color = '#333';
        item.style.transition = 'background-color 0.2s';
        item.setAttribute('data-lang', langCode);
        
        item.onmouseover = () => {
          item.style.backgroundColor = '#007bff';
          item.style.color = 'white';
        };
        item.onmouseout = () => {
          item.style.backgroundColor = 'white';
          item.style.color = '#333';
        };
        
        item.onclick = () => {
          translatePage(langCode);
          dropdown.style.display = 'none';
          resetBtn.style.display = 'inline-block';
          updateButtonText(langCode);
        };
        dropdown.appendChild(item);
      });
    }

    function updateButtonText(langCode) {
      const selectedLangName = languages[langCode].name;
      const langDisplayName = selectedLangName.split(' ')[0];
      
      // Clear button and rebuild
      while (translateBtn.firstChild) {
        translateBtn.removeChild(translateBtn.firstChild);
      }
      
      // Create SVG element
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      svg.setAttribute('width', '16');
      svg.setAttribute('height', '16');
      svg.setAttribute('fill', 'currentColor');
      svg.setAttribute('viewBox', '0 0 16 16');
      svg.style.marginRight = '5px';
      svg.style.verticalAlign = 'text-bottom';
      
      const path1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path1.setAttribute('d', 'M4.545 6.714 4.11 8H3l1.862-5h1.284L8 8H6.833l-.435-1.286H4.545zm1.634-.736L5.5 3.956h-.049l-.679 2.022H6.18z');
      
      const path2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path2.setAttribute('d', 'M0 2a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v3h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3H2a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H2zm7.138 9.995c.193.301.402.583.63.846-.748.575-1.673 1.001-2.768 1.292.178.217.451.635.555.867 1.125-.359 2.08-.844 2.886-1.494.777.665 1.739 1.165 2.93 1.472.133-.254.414-.673.629-.89-1.125-.253-2.057-.694-2.82-1.284.681-.747 1.222-1.651 1.621-2.757H14V8h-3v1.047h.765c-.318.844-.74 1.546-1.272 2.13a6.066 6.066 0 0 1-.415-.492 1.988 1.988 0 0 1-.94.31z');
      
      svg.appendChild(path1);
      svg.appendChild(path2);
      
      translateBtn.appendChild(svg);
      translateBtn.appendChild(document.createTextNode(langDisplayName));
    }

    async function translatePage(targetLang) {
      // Validate language code to prevent injection attacks
      if (!languages[targetLang]) {
        console.error('Invalid language code:', targetLang);
        return;
      }
      
      // Save preference
      localStorage.setItem('selectedLanguage', targetLang);
      
      // Show loading indicator
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'translation-loading';
      loadingDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #007bff; color: white; padding: 10px 20px; border-radius: 4px; z-index: 10000; box-shadow: 0 2px 8px rgba(0,0,0,0.2);';
      loadingDiv.textContent = 'Translating...';
      document.body.appendChild(loadingDiv);
      
      try {
        // Get all text elements to translate (more targeted approach)
        const elementsToTranslate = [];
        
        // Select specific elements that typically contain main content
        const selectors = ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'td', 'th', 'span.text', 'div.content', 'article', 'blockquote'];
        selectors.forEach(selector => {
          document.querySelectorAll(selector).forEach(el => {
            // Skip if element has children with block elements
            if (el.children.length === 0 || Array.from(el.children).every(child => 
              !['DIV', 'P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'UL', 'OL', 'TABLE'].includes(child.tagName))) {
              const text = el.textContent.trim();
              if (text && text.length > 0 && text.length < MAX_TEXT_LENGTH) {
                elementsToTranslate.push({ element: el, text: text });
              }
            }
          });
        });
        
        // Translate in smaller batches with delay to avoid rate limiting
        for (let i = 0; i < Math.min(elementsToTranslate.length, MAX_ELEMENTS_TO_TRANSLATE); i += BATCH_SIZE) {
          const batch = elementsToTranslate.slice(i, i + BATCH_SIZE);
          
          await Promise.all(batch.map(async (item) => {
            const translatedText = await translateText(item.text, targetLang);
            if (translatedText && translatedText !== item.text) {
              // Store original text if not already stored
              if (!item.element.hasAttribute('data-original-text')) {
                item.element.setAttribute('data-original-text', item.text);
              }
              item.element.textContent = translatedText;
            }
          }));
          
          // Update loading indicator
          loadingDiv.textContent = `Translating... ${Math.min(i + BATCH_SIZE, elementsToTranslate.length)}/${Math.min(elementsToTranslate.length, MAX_ELEMENTS_TO_TRANSLATE)}`;
          
          // Delay between batches
          if (i + BATCH_SIZE < Math.min(elementsToTranslate.length, MAX_ELEMENTS_TO_TRANSLATE)) {
            await new Promise(resolve => setTimeout(resolve, BATCH_DELAY_MS));
          }
        }
        
        loadingDiv.textContent = 'Translation complete!';
        setTimeout(() => {
          if (loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
          }
        }, 1500);
      } catch (error) {
        console.error('Translation error:', error);
        loadingDiv.textContent = 'Translation failed';
        loadingDiv.style.background = '#dc3545';
        setTimeout(() => {
          if (loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
          }
        }, 2000);
      }
    }

    async function translateText(text, targetLang) {
      // Validate language code to prevent injection attacks
      if (!languages[targetLang]) {
        console.error('Invalid language code:', targetLang);
        return text;
      }
      
      // Use MyMemory Translation API (free, no API key required)
      const sourceLang = 'ko';
      const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${encodeURIComponent(targetLang)}`;
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.responseStatus === 200 && data.responseData) {
          return data.responseData.translatedText;
        }
        return text; // Return original if translation fails
      } catch (error) {
        console.error('Translation API error:', error);
        return text; // Return original if API fails
      }
    }

    if (translateBtn) {
      translateBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (dropdown && !dropdown.contains(e.target) && e.target !== translateBtn) {
        dropdown.style.display = 'none';
      }
    });
    
    dropdown.addEventListener('click', (e) => e.stopPropagation());

    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        localStorage.removeItem('selectedLanguage');
        location.reload();
      });
    }
  });
</script>

<style>
  /* Dark mode support for translation dropdown */
  body.dark-mode #translate-dropdown {
    background: #2d3748 !important;
    border-color: #4a5568 !important;
  }
  
  body.dark-mode #translate-dropdown > div:first-child {
    background: #1a202c !important;
    color: #e2e8f0 !important;
    border-bottom-color: #4a5568 !important;
  }
  
  body.dark-mode #translate-dropdown > div[data-lang] {
    color: #e2e8f0 !important;
  }
  
  body.dark-mode #translate-dropdown > div[data-lang]:hover {
    background: #4299e1 !important;
    color: white !important;
  }
  
  /* Ensure dropdown is above other elements */
  #translate-dropdown {
    box-sizing: border-box;
  }
  
  #translate-dropdown > div[data-lang] {
    box-sizing: border-box;
  }
  
  /* Improve button styling */
  #translate-btn,
  #translate-reset-btn {
    font-size: 13px;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 4px;
    transition: all 0.2s;
  }
  
  #translate-btn:hover,
  #translate-reset-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  /* Loading indicator */
  #translation-loading {
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>
